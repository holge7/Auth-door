package com.door.security;

import java.nio.charset.StandardCharsets;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.buffer.DataBuffer;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.util.SerializationUtils;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;

import com.door.jwt.JwtUtils;
import com.door.utils.ApiResponse;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.primitives.Bytes;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Configuration
public class LogginFilter implements WebFilter{
    Log logger = LogFactory.getLog(getClass());
    
    JwtUtils jwtUtils;
    
    public LogginFilter(JwtUtils jwtUtils) {
    	this.jwtUtils = jwtUtils;
    }

	@Override
	public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {

		System.out.println("================");
		System.out.println("Loggin Filter");
		System.out.println("================");
	
		// Get Authorization Header
		String jwt = exchange.getRequest().getHeaders().getFirst("Authorization");
		
		// User try to access as auth user
		if (jwt!=null) {
			if (jwtUtils.validateJwtToken(jwt)) {
				System.out.println("Email: "+jwtUtils.getEmailNameFromJwtToken(jwt));
			} else {
				exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
		        ApiResponse response = new ApiResponse("Hello world");
		        byte[] responseBytes = setBodyResponse(response); 
		        DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(responseBytes);
		        exchange.getResponse().writeWith(Flux.just(buffer));
		        return Mono.empty();
			}
		}
		
		// jwt valid and user is authenticated or user try to access as anonymous
		return chain.filter(exchange);
	}
	
	public byte[] setBodyResponse(ApiResponse response) {
		ObjectMapper objectMapper = new ObjectMapper();
		String responseString;
		try {
			responseString = objectMapper.writeValueAsString(response);
		} catch (JsonProcessingException e) {
			logger.error("Fail parsing Object to String {}", e);
		}
		// Serialize response
		return SerializationUtils.serialize(response);
		//DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(bytes);
	}
	
}